name: Build Chrome Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=$(jq -r .version extension/manifest.json)" >> $GITHUB_OUTPUT
          fi

      - name: Update manifest version
        if: github.event.inputs.version != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          jq ".version = \"$VERSION\"" extension/manifest.json > extension/manifest.json.tmp
          mv extension/manifest.json.tmp extension/manifest.json
          echo "Updated manifest.json to version $VERSION"

      - name: Verify extension structure
        run: |
          echo "Checking extension files..."
          if [ ! -f "extension/manifest.json" ]; then
            echo "Error: manifest.json not found"
            exit 1
          fi

          if [ ! -f "extension/icon-16.png" ] || [ ! -f "extension/icon-48.png" ] || [ ! -f "extension/icon-128.png" ]; then
            echo "Error: Required icon files not found"
            exit 1
          fi

          echo "Extension structure verified âœ“"

      - name: Create Chrome Web Store package
        run: |
          cd extension
          zip -r ../canvasflow-extension-v${{ steps.version.outputs.version }}.zip \
            manifest.json \
            background.js \
            content.js \
            sidepanel.html \
            sidepanel.js \
            schedule.html \
            schedule.js \
            schedule.css \
            icon-16.png \
            icon-48.png \
            icon-128.png \
            lib/ \
            types/ \
            -x "*.md" "*.DS_Store" "*node_modules*"
          cd ..

          echo "Package created: canvasflow-extension-v${{ steps.version.outputs.version }}.zip"
          ls -lh canvasflow-extension-v${{ steps.version.outputs.version }}.zip

      - name: Verify ZIP contents
        run: |
          unzip -l canvasflow-extension-v${{ steps.version.outputs.version }}.zip

          # Check file count
          FILE_COUNT=$(unzip -l canvasflow-extension-v${{ steps.version.outputs.version }}.zip | grep -c "^-")
          echo "Total files in package: $FILE_COUNT"

      - name: Create native host package
        run: |
          cd native-host
          zip -r ../canvasflow-native-host-v${{ steps.version.outputs.version }}.zip \
            host.js \
            package.json \
            package-lock.json \
            manifest.json \
            README.md \
            -x "*.DS_Store" "*node_modules*"
          cd ..

          echo "Native host package created: canvasflow-native-host-v${{ steps.version.outputs.version }}.zip"
          ls -lh canvasflow-native-host-v${{ steps.version.outputs.version }}.zip

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          ## CanvasFlow v${{ steps.version.outputs.version }}

          ### Chrome Extension

          **What's New:**
          - AI-powered insights with Claude Extended Thinking
          - Weekly schedule generation
          - Direct Canvas data extraction (no API key required)
          - MCP server integration for Claude Desktop

          **Installation:**
          1. Download `canvasflow-extension-v${{ steps.version.outputs.version }}.zip`
          2. Extract the ZIP file
          3. Open Chrome and go to `chrome://extensions/`
          4. Enable "Developer mode"
          5. Click "Load unpacked" and select the extracted folder

          **For Chrome Web Store submission:**
          Use `canvasflow-extension-v${{ steps.version.outputs.version }}.zip` directly

          ### Native Host (Optional - for MCP Integration)

          **Installation:**
          1. Download `canvasflow-native-host-v${{ steps.version.outputs.version }}.zip`
          2. Extract and run the installation script
          3. See native-host/README.md for detailed instructions

          ---

          **Privacy Policy:** https://github.com/jonasneves/canvasflow/blob/main/PRIVACY.md
          **Documentation:** https://github.com/jonasneves/canvasflow/blob/main/README.md
          EOF

          cat release-notes.md

      - name: Upload extension package (for Chrome Web Store)
        uses: actions/upload-artifact@v4
        with:
          name: canvasflow-extension-v${{ steps.version.outputs.version }}
          path: extension/
          retention-days: 90

      - name: Upload extension ZIP (for releases)
        uses: actions/upload-artifact@v4
        with:
          name: canvasflow-extension-v${{ steps.version.outputs.version }}-zip
          path: canvasflow-extension-v${{ steps.version.outputs.version }}.zip
          retention-days: 90

      - name: Upload native host package
        uses: actions/upload-artifact@v4
        with:
          name: canvasflow-native-host-v${{ steps.version.outputs.version }}
          path: canvasflow-native-host-v${{ steps.version.outputs.version }}.zip
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            canvasflow-extension-v${{ steps.version.outputs.version }}.zip
            canvasflow-native-host-v${{ steps.version.outputs.version }}.zip
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Package summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages Created:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Chrome Extension: \`canvasflow-extension-v${{ steps.version.outputs.version }}\` (artifact)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Chrome Extension ZIP: \`canvasflow-extension-v${{ steps.version.outputs.version }}.zip\` (for releases)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Native Host: \`canvasflow-native-host-v${{ steps.version.outputs.version }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### File Sizes:" >> $GITHUB_STEP_SUMMARY
          ls -lh canvasflow-extension-v${{ steps.version.outputs.version }}.zip | awk '{print "- Extension ZIP: " $5}' >> $GITHUB_STEP_SUMMARY
          ls -lh canvasflow-native-host-v${{ steps.version.outputs.version }}.zip | awk '{print "- Native Host: " $5}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ For Chrome Web Store Submission:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`canvasflow-extension-v${{ steps.version.outputs.version }}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the downloaded zip to get the extension folder" >> $GITHUB_STEP_SUMMARY
          echo "3. Re-zip the extension folder contents (manifest.json must be at root)" >> $GITHUB_STEP_SUMMARY
          echo "4. Upload to Chrome Web Store Developer Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Alternative:** Use the GitHub Release zip file directly (available after release is created)" >> $GITHUB_STEP_SUMMARY
