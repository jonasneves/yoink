name: Release Native Host

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build and Release Native Host
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./native-host
        run: npm ci

      - name: Create distribution packages
        run: |
          # Create dist directory
          mkdir -p dist

          # Package for all platforms (cross-platform Node.js)
          cd native-host
          zip -r ../dist/canvasflow-native-host.zip \
            host.js \
            manifest.json \
            package.json \
            package-lock.json \
            install.sh \
            install.bat \
            README.md

          echo "Package created: canvasflow-native-host.zip"
          ls -lh ../dist/

      - name: Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Latest Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'nightly' }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && format('CanvasFlow Native Host {0}', github.ref_name) || 'CanvasFlow Native Host (Nightly)' }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          files: dist/canvasflow-native-host.zip
          body: |
            ## CanvasFlow Native Host ${{ steps.version.outputs.version }}

            Download and install the native messaging host to connect Claude Desktop to your Canvas data.

            ### Quick Download

            **Direct download link:**
            ```
            https://github.com/jonasneves/canvasflow/releases/download/latest/canvasflow-native-host.zip
            ```

            ### Installation

            **macOS/Linux:**
            ```bash
            curl -L https://github.com/jonasneves/canvasflow/releases/download/latest/canvasflow-native-host.zip -o canvasflow-native-host.zip
            unzip canvasflow-native-host.zip
            cd canvasflow-native-host
            chmod +x install.sh
            ./install.sh
            ```

            **Windows:**
            1. Download `canvasflow-native-host.zip` using the link above
            2. Extract the ZIP file
            3. Run `install.bat`

            ### Requirements

            - Node.js 14 or higher
            - CanvasFlow Chrome extension installed

            ### What's Included

            - Native messaging host server (`host.js`)
            - MCP server configuration (`manifest.json`)
            - Automated installers (`install.sh`, `install.bat`)
            - Installation instructions (`README.md`)
            - Node.js dependencies (`package.json`)

            ### Documentation

            Full installation guide: [native-host/README.md](https://github.com/jonasneves/canvasflow/blob/main/native-host/README.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
